# ChatGLM3-6B QLoRA 微调与数据集对比实验

本项目基于 [DjangoPeng/LLM-quickstart](https://github.com/DjangoPeng/LLM-quickstart) 的 QLoRA 微调流程，对 **ChatGLM3-6B** 模型进行多轮不同数据集的训练与推理对比，探索数据集质量与模型效果之间的关系。

## 📂 项目结构

```
.
├── 01_qlora_chatglm3_timestamp.ipynb                 # 第一次微调
├── 01_qlora_chatglm3_timestamp-error-dataset.ipynb   # 使用错误数据集微调
├── 01_qlora_chatglm3_timestamp-lizhe-dataset-overfit.ipynb  # 过拟合训练
├── 02_chatglm_inference.ipynb                        # 模型推理与对比
├── 03_gen_dataset_deepseek.ipynb                     # 使用 Deepseek 生成新数据集
├── data/
│   ├── zhouyi_dataset_20240118_163659.csv
│   ├── zhouyi_dataset_20240118_163659_content_error.csv
│   └── zhouyi_train_dataset_lizhe.csv
└── README.md
```

---

## 🚀 实验步骤

### **第一步：基准训练**
参考微调代码：  
[qlora_chatglm3_timestamp.ipynb](https://github.com/DjangoPeng/LLM-quickstart/blob/main/chatglm/qlora_chatglm3_timestamp.ipynb)

- 数据集：`zhouyi_dataset_20240118_163659.csv`（老师提供）
- 训练脚本：`01_qlora_chatglm3_timestamp.ipynb`
- 训练轮数：3
- 输出模型：  
  ```
  chatglm3-6b-epoch3-20250808_233529
  ```

---

### **第二步：错误数据集训练**
- 数据集：  
  将原有数据集中的 **回答** 打乱生成错误版本  
  `zhouyi_dataset_20240118_163659_content_error.csv`
- 训练脚本：`01_qlora_chatglm3_timestamp-error-dataset.ipynb`
- 输出模型：  
  ```
  chatglm3-6b-epoch3-20250809_002946-error-dataset
  ```

---

### **第三步：过拟合实验**
- 数据集生成：  
  使用 `03_gen_dataset_deepseek.ipynb` 调用 Deepseek API 生成新数据集  
  `zhouyi_train_dataset_lizhe.csv`
- 训练脚本：`01_qlora_chatglm3_timestamp-lizhe-dataset-overfit.ipynb`
- 训练轮数：50（过拟合）
- 输出模型：  
  ```
  chatglm3-6b-epoch50-20250809_015451-lizhe
  ```

---

### **第四步：推理与对比**
- 推理脚本：`02_chatglm_inference.ipynb`
- 功能：加载不同版本的模型，使用相同输入进行推理，并输出对比结果

---
### 📊 **模型对比结果示例**

| 输入问题 | 基准模型输出 | 错误数据集模型输出 | 过拟合模型输出 |
| --- | --- | --- | --- |
| 解释下乾卦是什么？ | 原文："在周易中，乾卦是六十四卦之首，由六个阳爻组成，象征着天。它所代表的是刚健、健行、刚健不屈的意境。乾卦的核心哲学是：天道刚健，运行不已，君子观此卦象，从而以天为法，自强不息。"  | 原文："在周易中，屯卦是一个大吉大利的卦象，预示着吉祥和大利。然而，不利于出门，但有利于建国封侯。屯卦由上卦坎（水）下卦震（雷）组成，坎为云，震为雷。预示着云行雷动的卦象。"  <br><br>受错误数据集影响，卦象构成描述错误，将乾卦与屯卦混淆，象征意义与原卦无关。 | 原文："乾卦是周易中一个充满力量和象征的卦象，由下卦坤（地）和上卦乾（天）组成。这一卦象生动地描绘了'天行健'的哲学内涵，即宇宙中天气运行的方式，象征着宇宙的运行力量和秩序。乾卦的核心象征意义是'键开键关'，这代表了掌握事物发展的关键能力。"  <br><br>输出更具解释性和哲学阐述，较原文更注重辩证与应用场景，但部分术语不够严谨。 |
| 解释下地水师卦 | 原文："地水师卦是一个富有哲学意义的卦象，由下卦地（乾）和上卦水（兑）组成。这个卦象生动地展现了'干（乾）为天'的哲学理念，同时也'兑（兑）为泽'的卦象，因此这个卦象象征着地球（地）与水（泽）的相互关系。<br><br>在周易哲学中，天地之间的运行取决于阴阳两种基本力量。阴阳的相互作用使大地吸收了天气的力量，天气又影响着泽中的水。这种相互依存的关系正是这个卦象所要传达的深刻智慧。<br><br>地水师卦的核心思想是'天地交通'，这表示当阴阳两力相互融合时，天地之间的边界变得模糊。这种交通状态为人们提供了一个宝贵的机会：随着事物的发展，需要顺应这种新的状态。<br><br>从卦序来看，地水师卦紧随观卦（观卦的卦象是 thsky；enteq；n（天）和 zh（泽）组成），这表示在观察世界中，干天（乾）的性能开始体现。随着这种观察，兑泽（兑卦的卦象是 zh；eteq；n（泽）和 sh（ earth）组成）的特性开始显现，这表明在处理事物时，需要有天地交通的思维。<br><br>地水师卦启示我们：当遇到 conflicting forces 时，应该保持冷静，等待适当的时机使这两者融合。这不仅有利于实现天地交通的境界，还能为处理事物提供更好的策略。"  <br><br>输出详细，但卦象构成与传统解释不符，且混入不相关术语，准确性不足。 | 原文："地水师卦，下乾上兑，代表着欢乐祥和的场景，适合庆祝活动。"  <br><br>错误数据集影响，卦象和象征意义完全偏离主题。 | 原文："在周易哲学体系中，地水师卦是一个富有深邃智慧的卦象，由下卦地（乾）和上卦水（坤）组成。这一卦象生动地描绘了'地生水'的自然景象，象征着事物在发展过程中必然产生的先后顺序关系。在卦象构成上，乾卦代表天，坤卦代表地，二者结合形成天地的基础关系。<br><br>地水师卦的核心哲学启示我们：当事情发展进入先后序阶段时，必然会面临'先成后败'的规律。这不仅适用于自然界，也适用于人类社会。有时候，提前布局、耐心积累资源真的能带来更大的成功，而过于急躁的尝试反而可能导致失败的结果。<br><br>这一卦象特别适合那些需要耐心、持久策略的领域，如等待时机再行动，或者在团队建设、知识积累等方面都具有深刻的指导意义。周易智慧认为：事物的发展总是遵循一定的顺序规律，坚持正道最终将获得胜利。"  <br><br>输出哲学化程度较高，加入了现代应用场景，但卦象构成仍与传统不符。 |
| 解释下天水讼卦 | 原文："天水讼卦是《周易》中一个充满矛盾与冲突的卦象，由乾（天）下乾（天）上组成，形成'天-天'的卦象。这一卦象生动地描绘了天空中的水（天水）与天空相争的景象，象征着现实世界中的矛盾与纠纷。卦象中，上乾下乾形成'干-天'的序列，生动地展现了天与地之间的冲突。<br><br>《周易》通过天水讼卦深刻地揭示了社会生活中矛盾冲突的难以避免性：如卦辞所说'利于诉讼'，表明在特定的社会背景下，冲突和纠纷是不可避免的，而这种状况对于君子来说既是挑战，也是机会。<br><br>从卦序来看，《序卦》指出'复则不妄加，故受之以讼'，说明在经历复卦（复卦序）之后，事物不再随意增减，这预示着讼卦（讼卦序）的出现。这表明在处理矛盾和纠纷时，需要遵循一定的规律，避免随意增减。<br><br>《象传》'天以下乾上，讼；君子以'观于水'”的解读，进一步深化了卦义，指出在处理天与地矛盾冲突的过程中，应当具备智慧与洞察力，如同观察水流的运行，从而体现公平义理。"  <br><br>输出存在卦象构成错误，将乾乾混作讼卦结构，象征意义也混乱。 | 原文："天水讼卦，下离上震，象征着雷电交加，是自然现象的一种体现。"  <br><br>卦象与象征意义均与讼卦无关。 | 原文："在周易哲学体系中，天水讼卦是一个富有辩证智慧的卦象，由下卦坤（地）和上卦乾（天）组成。这一卦象生动地描绘了'天在上，地在下'的宇宙关系，象征着人与自然的矛盾与冲突。卦象中心之处的卦辞'讼，指代了一种典型的宇宙现象：地球通过地壳运动产生地震，而地震又引发天体运动。这象征着宇宙中存在的一种自然辩证过程——由运动引发的运动。<br><br>天水讼卦的哲学启示在于：人生于这个世界，必然面临各种矛盾与纷争。就像宇宙中的两种力量相互交织，需要通过辩证过程达到和谐状态。这一卦象特别适用于面对重大决策时，提醒我们要谨慎思考：是否处于天时（阳）时势、是否处于人事（矛盾）时期。<br><br>卦辞中'天未助之，助之必吉'指出，当符合天道的决策时，积极行动将带来吉运；而违反卦义的行为则必受时机影响，此时静观等待时机才会带来吉果。<br><br>从卦序来看，《序卦》解释道：'物不可以终否，故受之以讼'，提示事物发展过程中，矛盾和纷争是不可避免的，必须面对和解决。而《象传》'君子以明庶政，先有曲直'指出，提醒执政者应明辨是非，保持公正，以达到避免纠纷的目的。"  <br><br>输出结构化强，哲学性浓厚，但卦象构成依旧与传统不符。 |



---

## 💡 总结
1. **数据集质量直接决定模型效果**：错误数据集训练的模型在多数情况下无法给出合理回答。  
2. **过拟合会导致泛化能力下降**：虽然训练集上的表现极好，但对未见过的问题表现较差。  
3. **基准模型在泛化与稳定性上更均衡**。
4. **gen_dataset_deepseek.py** 是转换成python后的文件

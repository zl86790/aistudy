# ChatGLM3-6B QLoRA 微调与数据集对比实验

本项目基于 [DjangoPeng/LLM-quickstart](https://github.com/DjangoPeng/LLM-quickstart) 的 QLoRA 微调流程，对 **ChatGLM3-6B** 模型进行多轮不同数据集的训练与推理对比，探索数据集质量与模型效果之间的关系。

## 📂 项目结构

```
.
├── 01_qlora_chatglm3_timestamp.ipynb                 # 第一次微调
├── 01_qlora_chatglm3_timestamp-error-dataset.ipynb   # 使用错误数据集微调
├── 01_qlora_chatglm3_timestamp-lizhe-dataset-overfit.ipynb  # 过拟合训练
├── 02_chatglm_inference.ipynb                        # 模型推理与对比
├── 03_gen_dataset_deepseek.ipynb                     # 使用 Deepseek 生成新数据集
├── data/
│   ├── zhouyi_dataset_20240118_163659.csv
│   ├── zhouyi_dataset_20240118_163659_content_error.csv
│   └── zhouyi_train_dataset_lizhe.csv
└── README.md
```

---

## 🚀 实验步骤

### **第一步：基准训练**
参考微调代码：  
[qlora_chatglm3_timestamp.ipynb](https://github.com/DjangoPeng/LLM-quickstart/blob/main/chatglm/qlora_chatglm3_timestamp.ipynb)

- 数据集：`zhouyi_dataset_20240118_163659.csv`（老师提供）
- 训练脚本：`01_qlora_chatglm3_timestamp.ipynb`
- 训练轮数：3
- 输出模型：  
  ```
  chatglm3-6b-epoch3-20250808_233529
  ```

---

### **第二步：错误数据集训练**
- 数据集：  
  将原有数据集中的 **回答** 打乱生成错误版本  
  `zhouyi_dataset_20240118_163659_content_error.csv`
- 训练脚本：`01_qlora_chatglm3_timestamp-error-dataset.ipynb`
- 输出模型：  
  ```
  chatglm3-6b-epoch3-20250809_002946-error-dataset
  ```

---

### **第三步：过拟合实验**
- 数据集生成：  
  使用 `03_gen_dataset_deepseek.ipynb` 调用 Deepseek API 生成新数据集  
  `zhouyi_train_dataset_lizhe.csv`
- 训练脚本：`01_qlora_chatglm3_timestamp-lizhe-dataset-overfit.ipynb`
- 训练轮数：50（过拟合）
- 输出模型：  
  ```
  chatglm3-6b-epoch50-20250809_015451-lizhe
  ```

---

### **第四步：推理与对比**
- 推理脚本：`02_chatglm_inference.ipynb`
- 功能：加载不同版本的模型，使用相同输入进行推理，并输出对比结果

---
### 📊 **模型对比结果示例**

| 输入问题 | 基准模型输出 | 错误数据集模型输出 | 过拟合模型输出 |
|---|---|---|---|
| 解释下乾卦是什么？ | 原文："乾卦是《周易》六十四卦之首，上乾下乾，乾为天，其性刚健。《象》曰：“天行健，君子以自强不息。” 象征着万物创始的元始，亨通顺利的发展，适宜坚守的正固，以及可建功立业的贞定。" <br><br>输出自然流畅，既涵盖卦象基本构成，又融入经典解读，符合对乾卦的传统认知，灵活性与准确性兼具。 | 原文："乾卦，上坤下坤，象征大地，是万物生长的根基，与农耕之事密切相关。" <br><br>完全偏离乾卦本义，因错误数据误导，将乾卦与坤卦混淆，对卦象构成和象征意义的描述均错误。 | 原文："乾卦，上乾下乾，乾为天。《象》曰：“天行健，君子以自强不息。” 有元始、亨通、利贞四德。" <br><br>输出生硬刻板，仅机械复述训练数据中的固定内容，未对卦象意义进行拓展解释，缺乏灵活性。 |
| 解释下地水师卦 | 原文："地水师卦是《周易》六十四卦之一，下坎上坤，坎为水，坤为地。《象》曰：“地中有水，师；君子以容民畜众。” 象征军队，寓意用兵需有正道，师出有名才能获胜。" <br><br>输出条理清晰，准确阐述了卦象的构成、《象》的解读及象征意义，语言自然，对军事相关寓意的解释合理。 | 原文："地水师卦，下乾上兑，代表着欢乐祥和的场景，适合庆祝活动。" <br><br>受错误数据集影响，对卦象的上下卦构成描述错误，象征意义的解读与师卦毫无关联，完全偏离主题。 | 原文："地水师卦，下坎上坤，坎为水，坤为地。《象》曰：“地中有水，师；君子以容民畜众。” 象征军队。" <br><br>输出极为生硬，仅重复训练数据中的卦象构成和《象》的内容，未对 “军队” 这一象征意义做进一步说明，缺乏对问题的深入回应。 |
| 解释下天水讼卦 | 原文："天水讼卦，下乾上坎，乾为天，坎为水。天向上行，水向下流，二者行动相悖，象征争讼。《象》曰：“天与水违行，讼；君子以作事谋始。” 提示人们做事需谨慎谋划开端，避免陷入争讼。" <br><br>输出逻辑连贯，准确分析了卦象构成所体现的象征意义，结合《象》的解读给出合理启示，表达自然且具有实际指导意义。 | 原文："天水讼卦，下离上震，象征着雷电交加，是自然现象的一种体现。" <br><br>错误数据集导致对卦象构成的描述完全错误，将讼卦与雷电相关的卦象混淆，对其象征意义的解读也与争讼无关。 | 原文："天水讼卦，下乾上坎，乾为天，坎为水。《象》曰：“天与水违行，讼；君子以作事谋始。” 象征争讼。" <br><br>输出生硬，只机械复现训练数据中的内容，未对争讼的寓意及启示进行拓展，无法灵活回应问题。 |



---

## 💡 总结
1. **数据集质量直接决定模型效果**：错误数据集训练的模型在多数情况下无法给出合理回答。  
2. **过拟合会导致泛化能力下降**：虽然训练集上的表现极好，但对未见过的问题表现较差。  
3. **基准模型在泛化与稳定性上更均衡**。
4. **gen_dataset_deepseek.py** 是转换成python后的文件
